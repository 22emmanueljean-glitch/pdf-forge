<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF Forge — Drag & Drop Editor</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<style>
  :root{--bg:#0f1115;--panel:#151821;--card:#1a1f2b;--muted:#9aa3b2;--accent:#7aa2ff;--ok:#3ecf8e;--err:#ff6b6b;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e7eaf0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;height:100vh}
  @media (max-width:980px){.grid{grid-template-columns:1fr;height:auto}}
  .left{padding:16px;overflow:auto;background:#151821;border-right:1px solid #1f2330}
  .right{position:relative;overflow:auto;background:#0b0d13}
  h1{font-size:18px;margin:6px 0 10px}
  .card{background:#1a1f2b;border:1px solid #22283a;border-radius:12px;padding:12px;margin:10px 0}
  label{font-size:12px;color:#9aa3b2}
  input,textarea,select,button{width:100%;margin-top:6px}
  input,textarea,select{background:#121620;border:1px solid #2a3246;color:#e7eaf0;border-radius:10px;padding:10px}
  textarea{min-height:120px;font-family:ui-monospace,Menlo,Consolas,monospace;resize:vertical}
  button{background:#7aa2ff;border:0;border-radius:10px;padding:12px;font-weight:700;color:#0b0d13;cursor:pointer}
  button.secondary{background:#28304a;color:#e7eaf0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .status{margin-top:8px;font-size:12px;color:#9aa3b2}
  .status.ok{color:#3ecf8e} .status.err{color:#ff6b6b}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#22283a;color:#c7d0e0;font-size:12px;margin-right:6px}
  .toolbar{position:sticky;top:0;background:#0b0d13;z-index:2;padding:12px;border-bottom:1px solid #1a1f2b;display:flex;gap:8px;align-items:center}
  .toolbar input[type=range]{width:160px}
  #stage{position:relative;min-height:60vh;display:flex;align-items:center;justify-content:center;}
  canvas{display:block;margin:0 auto;background:#0b0d13}
  #overlay{position:absolute;inset:0;pointer-events:none}
  .block{position:absolute;min-width:80px;min-height:30px;padding:6px 8px;background:#111523d0;border:1px dashed #7aa2ff;border-radius:6px;color:#e7eaf0;pointer-events:auto;cursor:move;white-space:pre-wrap;line-height:1.35}
  .handle{position:absolute;right:-8px;bottom:-8px;width:14px;height:14px;border:2px solid #7aa2ff;border-radius:3px;background:#111523;cursor:nwse-resize}
  .coords{position:absolute;left:12px;bottom:12px;background:#111523bd;padding:6px 10px;border-radius:8px;font-size:12px;color:#c7d0e0;border:1px solid #22283a}
  .marker{position:absolute;width:12px;height:12px;border:2px solid #8fb1ff;border-radius:50%;transform:translate(-6px,-6px);pointer-events:none}
  .list{font-size:12px;margin-top:8px}
  .list button{padding:6px 8px;margin-top:6px}
</style>
</head>
<body>
<div class="grid">
  <div class="left">
    <h1>PDF Forge — Drag & Drop</h1>

    <div class="card">
      <label>Upload PDF</label>
      <input type="file" id="file" accept="application/pdf"/>
      <div class="row" style="margin-top:10px">
        <button id="load">Load Preview</button>
        <button id="reset" class="secondary">Clear</button>
      </div>
      <div class="status" id="stat">No file loaded.</div>
    </div>

    <div class="card" id="tools" style="display:none">
      <div class="row">
        <div>
          <label>Page</label>
          <select id="pageSelect"></select>
        </div>
        <div>
          <label>Zoom</label>
          <input type="range" id="zoom" min="50" max="200" value="110">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Font</label>
          <input id="font" placeholder="Times-Roman" value="Times-Roman">
        </div>
        <div>
          <label>Size (pt)</label>
          <input id="size" type="number" step="0.5" value="11">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Color</label>
          <input id="color" type="color" value="#000000">
        </div>
        <div>
          <label>Width (pt)</label>
          <input id="width" type="number" value="460">
        </div>
      </div>

      <label>Text</label>
      <textarea id="text" placeholder="Type anything you want to add…"></textarea>

      <div class="row">
        <button id="add">Add Block (click canvas to place)</button>
        <button id="apply" class="secondary">Generate v4</button>
      </div>

      <div class="list" id="blocksList"></div>
      <div class="status" id="queued">0 queued</div>
    </div>
  </div>

  <div class="right">
    <div class="toolbar">
      <span class="pill" id="meta">Page — | scale 1.00</span>
      <button id="prev" class="secondary">◀</button>
      <button id="next" class="secondary">▶</button>
    </div>
    <div id="stage">
      <canvas id="cv"></canvas>
      <div id="overlay"></div>
      <div class="coords" id="xy">x: —, y: —</div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
const API_EDIT = "/api/edit"; // your backend endpoint

// state
let pdfDoc=null, pageNum=1, pageCount=1, scale=1.10, ptPerPx=1;
let fileB64=null, lastClickPx=null, lastClickPt=null;
let blocks=[]; // {id,page,xPt,yPt,widthPt,text,font,size,colorHex,pxWidth,pxHeight}

// helpers
const $ = id => document.getElementById(id);
const b64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
const fromB64 = s => new Blob([Uint8Array.from(atob(s), c=>c.charCodeAt(0))], {type:"application/pdf"});
const setStat = (t,cls="") => { const el=$('stat'); el.textContent=t; el.className="status "+cls; };
const setMeta = () => $('meta').textContent = `Page ${pageNum} | scale ${scale.toFixed(2)}`;
const setQueued = () => $('queued').textContent = blocks.length + " queued";

// pdf.js worker
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// load preview
$('load').onclick = async () => {
  try{
    const f = $('file').files[0]; if(!f){ setStat("Choose a PDF."); return; }
    const buf = await f.arrayBuffer(); fileB64 = b64(buf);
    pdfDoc = await pdfjsLib.getDocument({data: buf}).promise;
    pageCount = pdfDoc.numPages; pageNum = 1;
    await renderPage();
    $('tools').style.display = '';
    // build page selector
    const sel = $('pageSelect'); sel.innerHTML="";
    for(let i=1;i<=pageCount;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); sel.appendChild(o); }
    sel.value="2";
    setStat(`Loaded ${pageCount} page(s). Click the canvas to set placement, then "Add Block".`, "ok");
  }catch(e){ setStat("Error: "+e.message, "err"); }
};

$('reset').onclick = ()=>{
  pdfDoc=null; pageNum=1; pageCount=1; fileB64=null; blocks=[]; lastClickPx=null; lastClickPt=null;
  $('cv').getContext('2d').clearRect(0,0,$('cv').width,$('cv').height);
  $('overlay').innerHTML=""; $('tools').style.display='none'; setQueued(); setStat("Cleared.");
};

$('prev').onclick = async()=>{ if(!pdfDoc)return; pageNum=Math.max(1,pageNum-1); $('pageSelect').value=String(pageNum); await renderPage(); drawBlocks(); };
$('next').onclick = async()=>{ if(!pdfDoc)return; pageNum=Math.min(pageCount,pageNum+1); $('pageSelect').value=String(pageNum); await renderPage(); drawBlocks(); };
$('zoom').oninput = async e=>{ if(!pdfDoc) return; scale = Number(e.target.value)/100; await renderPage(); drawBlocks(); };
$('pageSelect').onchange = async e=>{ pageNum = Number(e.target.value)||1; await renderPage(); drawBlocks(); };

// render page
async function renderPage(){
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale });
  const cv = $('cv'), ctx = cv.getContext('2d');
  cv.width = viewport.width; cv.height = viewport.height;
  const baseViewport = page.getViewport({ scale: 1 });
  ptPerPx = baseViewport.width / viewport.width; // PDF points per pixel (at current scale)
  await page.render({ canvasContext: ctx, viewport }).promise;
  setMeta();
}

// click to set placement
$('cv').addEventListener('click', e=>{
  const rect = $('cv').getBoundingClientRect();
  const pxX = e.clientX - rect.left;
  const pxY = e.clientY - rect.top;
  lastClickPx = {x:pxX, y:pxY};
  lastClickPt = {x:Math.round(pxX*ptPerPx), y:Math.round(pxY*ptPerPx)};
  showMarker(pxX, pxY);
});

function showMarker(pxX, pxY){
  let m = document.querySelector('.marker');
  if(!m){ m = document.createElement('div'); m.className='marker'; $('stage').appendChild(m); }
  const rect = $('cv').getBoundingClientRect();
  m.style.left = (rect.left + pxX) + 'px';
  m.style.top  = (rect.top + pxY) + 'px';
}

// add block
$('add').onclick = ()=>{
  if(!fileB64){ setStat("Load a PDF first.", "err"); return; }
  const pg = Number($('pageSelect').value)||pageNum;
  if(!lastClickPx){ setStat("Click the canvas to choose a position first.", "err"); return; }
  const text = $('text').value||"";
  const font = $('font').value||"Times-Roman";
  const size = parseFloat($('size').value)||11;
  const colorHex = $('color').value||"#000000";
  const widthPt = parseFloat($('width').value)||460;
  const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random());

  const block = {
    id, page: pg,
    xPt: lastClickPt.x, yPt: lastClickPt.y,
    widthPt, text, font, size, colorHex
  };
  blocks.push(block);
  setQueued();
  drawBlocks();
  appendBlockRow(block);
  $('text').value="";
  setStat("Block added. Drag it to fine-tune.", "ok");
};

// draw overlay blocks (for current page only)
function drawBlocks(){
  const ov = $('overlay'); ov.innerHTML="";
  const rect = $('cv').getBoundingClientRect();
  ov.style.left = rect.left + 'px';
  ov.style.top  = rect.top  + 'px';
  ov.style.width  = rect.width + 'px';
  ov.style.height = rect.height + 'px';

  blocks.filter(b=>b.page===pageNum).forEach(b=>{
    const div = document.createElement('div');
    div.className = 'block';
    const pxX = b.xPt/ptPerPx;
    const pxY = b.yPt/ptPerPx;
    const pxW = b.widthPt/ptPerPx;

    div.style.left = pxX+'px';
    div.style.top  = pxY+'px';
    div.style.width= pxW+'px';
    div.style.fontFamily = b.font;
    div.style.fontSize   = (b.size/ptPerPx)+'px'; // approximate preview
    div.style.color = b.colorHex;
    div.textContent = b.text;

    const handle = document.createElement('div');
    handle.className='handle';
    div.appendChild(handle);

    // dragging
    let drag=false, sx=0, sy=0, startLeft=0, startTop=0;
    div.addEventListener('mousedown', ev=>{
      drag=true; sx=ev.clientX; sy=ev.clientY;
      startLeft = parseFloat(div.style.left); startTop = parseFloat(div.style.top);
      ev.preventDefault();
    });
    window.addEventListener('mousemove', ev=>{
      if(!drag) return;
      const dx=ev.clientX-sx, dy=ev.clientY-sy;
      div.style.left = (startLeft+dx)+'px';
      div.style.top  = (startTop+dy)+'px';
    });
    window.addEventListener('mouseup', ev=>{
      if(!drag) return; drag=false;
      // update block pt coords
      const newPxX = parseFloat(div.style.left);
      const newPxY = parseFloat(div.style.top);
      b.xPt = Math.round(newPxX*ptPerPx);
      b.yPt = Math.round(newPxY*ptPerPx);
      updateBlockRow(b);
    });

    // resize via handle
    let rdrag=false, rsx=0, startW=0;
    handle.addEventListener('mousedown', ev=>{
      rdrag=true; rsx=ev.clientX; startW=parseFloat(div.style.width);
      ev.stopPropagation(); ev.preventDefault();
    });
    window.addEventListener('mousemove', ev=>{
      if(!rdrag) return;
      const dx=ev.clientX-rsx;
      const newW = Math.max(60, startW+dx);
      div.style.width = newW+'px';
    });
    window.addEventListener('mouseup', ev=>{
      if(!rdrag) return; rdrag=false;
      b.widthPt = Math.round(parseFloat(div.style.width)*ptPerPx);
      updateBlockRow(b);
    });

    ov.appendChild(div);
  });
}

// list rows
function appendBlockRow(b){
  const list = $('blocksList');
  const row = document.createElement('div');
  row.id = 'row-'+b.id;
  row.style.marginTop='8px';
  row.innerHTML = `
    <div class="pill">p${b.page}</div>
    <div class="pill">x:${b.xPt} y:${b.yPt}</div>
    <div class="pill">${b.font} ${b.size}pt</div>
    <div class="row" style="margin-top:6px">
      <button data-id="${b.id}" class="secondary">Select</button>
      <button data-id="${b.id}" class="del">Delete</button>
    </div>
  `;
  list.appendChild(row);
  row.querySelector('.secondary').onclick = ()=>{
    $('pageSelect').value = String(b.page);
    pageNum = b.page; renderPage().then(drawBlocks);
    // flash?
  };
  row.querySelector('.del').onclick = ()=>{
    blocks = blocks.filter(x=>x.id!==b.id);
    const r = $('row-'+b.id); if(r) r.remove();
    drawBlocks(); setQueued();
  };
}
function updateBlockRow(b){
  const row = $('row-'+b.id);
  if(row){
    row.querySelectorAll('.pill')[1].textContent = `x:${b.xPt} y:${b.yPt}`;
  }
}

// apply
$('apply').onclick = async ()=>{
  try{
    if(!fileB64){ setStat("Load a PDF first.", "err"); return; }
    if(blocks.length===0){ setStat("No edits queued.", "err"); return; }
    setStat("Generating…");
    const edits = blocks.map(b=>{
      const rgb = hexToRgb(b.colorHex);
      return {
        page: b.page, x: b.xPt, y: b.yPt,
        text: b.text, font: b.font, size: b.size,
        color: rgb, width: b.widthPt
      };
    });
    const payload = { file: fileB64, edits };
    const r = await fetch(API_EDIT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!r.ok){ const t=await r.text(); throw new Error(t||r.statusText); }
    const { pdf } = await r.json();
    const blob = fromB64(pdf);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='Gravitational_Aura_Masterclass_FINAL_CLEAN_v4.pdf'; a.click();
    setStat("Done ✓ File downloaded.", "ok");
  }catch(e){ setStat("Error: "+e.message, "err"); }
};

function hexToRgb(hex){
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if(!m) return [0,0,0];
  return [ parseInt(m[1],16)/255, parseInt(m[2],16)/255, parseInt(m[3],16)/255 ];
}
</script>
</body>
</html>
