<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF Forge — Universal Editor</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<style>
  :root{--bg:#0f1115;--panel:#151821;--card:#1a1f2b;--muted:#9aa3b2;--accent:#7aa2ff;--ok:#3ecf8e;--err:#ff6b6b;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e7eaf0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;height:100vh}
  @media (max-width:980px){.grid{grid-template-columns:1fr;height:auto}}
  .left{padding:16px;overflow:auto;background:var(--panel);border-right:1px solid #1f2330}
  .right{position:relative;overflow:auto;background:#0b0d13}
  h1{font-size:18px;margin:6px 0 10px}
  .card{background:var(--card);border:1px solid #22283a;border-radius:12px;padding:12px;margin:10px 0}
  label{font-size:12px;color:var(--muted)}
  input,textarea,select,button{width:100%;margin-top:6px}
  input,textarea,select{background:#121620;border:1px solid #2a3246;color:#e7eaf0;border-radius:10px;padding:10px}
  textarea{min-height:120px;font-family:ui-monospace,Menlo,Consolas,monospace}
  button{background:var(--accent);border:0;border-radius:10px;padding:12px;font-weight:700;color:#0b0d13;cursor:pointer}
  button.secondary{background:#28304a;color:#e7eaf0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .status{margin-top:8px;font-size:12px;color:var(--muted)}
  .status.ok{color:var(--ok)} .status.err{color:var(--err)}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#22283a;color:#c7d0e0;font-size:12px;margin-right:6px}
  .toolbar{position:sticky;top:0;background:#0b0d13;z-index:2;padding:12px;border-bottom:1px solid #1a1f2b;display:flex;gap:8px;align-items:center}
  .toolbar input[type=range]{width:160px}
  canvas{display:block;margin:0 auto;cursor:crosshair}
  .coords{position:absolute;left:12px;bottom:12px;background:#111523bd;padding:6px 10px;border-radius:8px;font-size:12px;color:#c7d0e0;border:1px solid #22283a}
  .cross{position:absolute;width:14px;height:14px;border-left:2px solid #8fb1ff;border-top:2px solid #8fb1ff;transform:translate(-7px,-7px) rotate(45deg);pointer-events:none}
</style>
</head>
<body>
<div class="grid">
  <div class="left">
    <h1>PDF Forge — Universal Editor</h1>

    <div class="card">
      <label>Upload PDF</label>
      <input type="file" id="file" accept="application/pdf" />
      <div class="row" style="margin-top:10px">
        <button id="load">Load Preview</button>
        <button id="reset" class="secondary">Clear</button>
      </div>
      <div class="status" id="stat">No file loaded.</div>
    </div>

    <div class="card" id="tools" style="display:none">
      <div class="row">
        <div>
          <label>Target Page</label>
          <select id="pageSelect"></select>
        </div>
        <div>
          <label>Placement</label>
          <select id="placeMode">
            <option value="click">Place where I click</option>
            <option value="append">Append below last paragraph</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Style (auto if available)</label>
          <select id="styleSelect"><option value="-1">(auto / default)</option></select>
        </div>
        <div>
          <label>Font / Size (manual override)</label>
          <div class="row">
            <input id="font" placeholder="Times-Roman">
            <input id="size" type="number" step="0.5" placeholder="11">
          </div>
        </div>
      </div>

      <label>Text Block</label>
      <textarea id="text"></textarea>

      <div class="row">
        <button id="queue">Queue Block</button>
        <button id="apply" class="secondary">Generate</button>
      </div>
      <div style="margin-top:6px">
        <span class="pill" id="queued">0 queued</span>
        <span class="pill">click on preview to set X/Y (if using “Place where I click”)</span>
      </div>
    </div>

    <div class="card" id="prefills" style="display:none">
      <label>Prefills</label>
      <div class="row" style="margin-top:8px">
        <button id="prefEp">Epictetus → Page 2</button>
        <button id="prefRu">Rumi → Page 3</button>
      </div>
    </div>

    <div class="card" id="debugBox" style="display:none">
      <label>Queued Edits (JSON)</label>
      <textarea id="jsonEdits" readonly></textarea>
    </div>
  </div>

  <div class="right">
    <div class="toolbar">
      <span class="pill" id="meta">Page — | scale 1.00</span>
      <input type="range" id="zoom" min="50" max="200" value="110">
      <button id="prev" class="secondary">◀</button>
      <button id="next" class="secondary">▶</button>
    </div>
    <div id="stage" style="position:relative;min-height:60vh;display:flex;align-items:center;justify-content:center;">
      <canvas id="cv"></canvas>
      <div id="marker" class="cross" style="display:none"></div>
      <div class="coords" id="xy">x: —, y: —</div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
const API_EDIT = "/api/edit";      // your deployed edit function
const API_ANALYZE = "/api/analyze"; // optional; skips gracefully if missing

// state
let pdfDoc=null, pageNum=1, pageCount=1, scale=1.10, ptPerPx=1, lastXY={x:null,y:null};
let fileB64=null, analysis=null, hasAnalyze=false;
const edits=[];

// helpers
const $ = id => document.getElementById(id);
const b64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
const fromB64 = s => new Blob([Uint8Array.from(atob(s), c=>c.charCodeAt(0))], {type:"application/pdf"});
const setStat = (t,cls="") => { const el=$('stat'); el.textContent=t; el.className="status "+cls; };
const setQueued = () => { $('queued').textContent = edits.length + " queued"; $('jsonEdits').value = JSON.stringify(edits, null, 2); };
const setMeta = () => $('meta').textContent = `Page ${pageNum} | scale ${scale.toFixed(2)}`;
const setXY   = () => $('xy').textContent = (lastXY.x==null) ? 'x: —, y: —' : `x: ${lastXY.x}, y: ${lastXY.y}`;

// pdf.js worker
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// load preview
$('load').onclick = async () => {
  try{
    const f = $('file').files[0];
    if(!f){ setStat("Choose a PDF."); return; }
    setStat("Loading preview…");
    const buf = await f.arrayBuffer();
    fileB64 = b64(buf);
    pdfDoc = await pdfjsLib.getDocument({data: buf}).promise;
    pageCount = pdfDoc.numPages; pageNum = 1;
    await renderPage();
    $('tools').style.display = '';
    $('prefills').style.display = '';
    $('debugBox').style.display = '';
    // build page selector
    const sel = $('pageSelect'); sel.innerHTML="";
    for(let i=1;i<=pageCount;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); sel.appendChild(o); }
    sel.value = "2";
    // try analyze (graceful if missing)
    await tryAnalyze();
    setStat(`Loaded ${pageCount} page(s). Click to place, or use Append mode.`);
  }catch(err){
    setStat("Error: "+err.message, "err");
  }
};

$('reset').onclick = () => {
  pdfDoc=null; analysis=null; hasAnalyze=false; fileB64=null; pageNum=1; lastXY={x:null,y:null};
  $('cv').getContext('2d').clearRect(0,0,$('cv').width,$('cv').height);
  edits.splice(0); setQueued(); setStat("Cleared."); $('tools').style.display='none'; $('prefills').style.display='none'; $('debugBox').style.display='none';
};

// analyze (optional)
async function tryAnalyze(){
  try{
    const r = await fetch(API_ANALYZE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ file: fileB64 }) });
    if(!r.ok) throw new Error("analyze not available");
    const ct = r.headers.get('content-type')||'';
    if(!ct.includes('application/json')) throw new Error("analyze returned non-JSON");
    analysis = await r.json();
    hasAnalyze = !!(analysis && analysis.pages);
    populateStylesForPage(Number($('pageSelect').value) || 1);
  }catch(e){
    hasAnalyze = false;
    $('styleSelect').innerHTML = '<option value="-1">(auto unavailable)</option>';
  }
}

// styles for a page
function populateStylesForPage(pg){
  const sel = $('styleSelect'); sel.innerHTML="";
  if(!hasAnalyze){ sel.innerHTML = '<option value="-1">(auto unavailable)</option>'; return; }
  const pageInfo = analysis.pages.find(p=>p.page===pg);
  if(!pageInfo || !pageInfo.styles || pageInfo.styles.length===0){
    sel.innerHTML = '<option value="-1">(no styles found)</option>'; return;
  }
  pageInfo.styles.forEach((s,idx)=>{
    const o=document.createElement('option');
    const hex = "#" + (s.color>>>0).toString(16).padStart(6,"0");
    o.value=String(idx);
    o.textContent = `${idx}: ${s.font} • ${s.size}pt • ${hex} • x${s.count}`;
    sel.appendChild(o);
  });
  sel.value = "0";
}

// render page
async function renderPage(){
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale });
  const cv = $('cv'), ctx = cv.getContext('2d');
  cv.width = viewport.width; cv.height = viewport.height;
  const baseViewport = page.getViewport({ scale: 1 });
  ptPerPx = baseViewport.width / viewport.width;
  await page.render({ canvasContext: ctx, viewport }).promise;
  setMeta(); setXY(); $('marker').style.display='none';
}

$('prev').onclick = async ()=>{ if(!pdfDoc) return; pageNum = Math.max(1, pageNum-1); $('pageSelect').value=String(pageNum); if(hasAnalyze) populateStylesForPage(pageNum); await renderPage(); }
$('next').onclick = async ()=>{ if(!pdfDoc) return; pageNum = Math.min(pageCount, pageNum+1); $('pageSelect').value=String(pageNum); if(hasAnalyze) populateStylesForPage(pageNum); await renderPage(); }
$('zoom').oninput = async e => { if(!pdfDoc) return; scale = Number(e.target.value)/100; await renderPage(); }
$('pageSelect').onchange = async e => { pageNum = Number(e.target.value)||1; if(hasAnalyze) populateStylesForPage(pageNum); await renderPage(); }

// click-to-place
$('cv').addEventListener('click', e=>{
  if(!$('placeMode') || $('placeMode').value!=='click') return;
  const rect = $('cv').getBoundingClientRect();
  const px = e.clientX - rect.left;
  const py = e.clientY - rect.top;
  const x = Math.round(px * ptPerPx);
  const y = Math.round(py * ptPerPx);
  lastXY = {x,y};
  const m = $('marker'); m.style.left = `${e.clientX}px`; m.style.top = `${e.clientY}px`; m.style.display='block';
  setXY();
  if(hasAnalyze){
    const sid = nearestStyleFor(pageNum, x, y);
    if(sid!==null) $('styleSelect').value = String(sid);
  }
});

// nearest style
function nearestStyleFor(pg, x, y){
  const pageInfo = analysis.pages.find(p=>p.page===pg);
  if(!pageInfo) return null;
  let best=null, bestD=1e15;
  for(const bl of (pageInfo.blocks||[])){
    const [x0,y0,x1,y1]=bl.bbox||[0,0,0,0];
    const cx=(x0+x1)/2, cy=(y0+y1)/2;
    const d=(cx-x)*(cx-x)+(cy-y)*(cy-y);
    if(d<bestD){ bestD=d; best=bl; }
  }
  if(!best) return 0;
  const sid = (pageInfo.styles||[]).findIndex(s=>s.font===best.font && s.size===best.size && s.color===best.color);
  return sid>=0 ? sid : 0;
}

// prefills
$('prefEp').onclick = ()=>{
  $('pageSelect').value = "2";
  $('text').value = `Epictetus — The Enchiridion
“It’s not what happens to you, but how you react to it that matters.”
Stoic acceptance turns chaos into composure. Control is limited to inner posture, not outer circumstance. Those who master interpretation become immovable.
• Reframe difficulty as training.
• Expect disruption; greet it with composure.
• Respond, never react.
Takeaway: Control begins where resistance ends.`;
};
$('prefRu').onclick = ()=>{
  $('pageSelect').value = "3";
  $('text').value = `Rumi — Masnavi
“What you seek is seeking you.”
Magnetic presence arises from sincerity of purpose. When desire is aligned with truth, others feel its pull. Stillness doesn’t chase — it attracts.
• Align ambition with authenticity.
• Speak from conviction, not comparison.
• Let stillness signal strength.
Takeaway: Alignment radiates further than effort.`;
};

// queue an edit
$('queue').onclick = ()=>{
  if(!fileB64){ setStat("Load a PDF first.", "err"); return; }
  const pg = Number($('pageSelect').value)||1;
  const mode = $('placeMode').value;

  let x,y;
  if(mode==='click'){
    if(lastXY.x==null){ setStat("Click on the preview to set X/Y first.", "err"); return; }
    x=lastXY.x; y=lastXY.y;
  } else {
    // append mode
    if(hasAnalyze){
      const pageInfo = analysis.pages.find(p=>p.page===pg);
      if(pageInfo && pageInfo.blocks && pageInfo.blocks.length){
        let maxY=0; for(const bl of pageInfo.blocks){ const y1=(bl.bbox||[0,0,0,0])[3]; if(y1>maxY) maxY=y1; }
        x=72; y=Math.min(maxY+24, 760);
      } else { x=72; y=720; }
    } else { x=72; y=720; }
  }

  const sid = Number($('styleSelect').value);
  const txt = $('text').value||"";
  const font = $('font').value.trim();
  const size = $('size').value.trim();

  const edit = { page: pg, x, y, text: txt };
  if(hasAnalyze && sid>=0) edit.style_ref = { page: pg, id: sid };
  if(font) edit.font = font;
  if(size) edit.size = Number(size);

  edits.push(edit);
  setQueued();
  setStat(`Queued edit for page ${pg} at (${x}, ${y}).`, "ok");
  $('text').value="";
};

// apply edits
$('apply').onclick = async ()=>{
  try{
    if(!fileB64){ setStat("Load a PDF first.", "err"); return; }
    if(edits.length===0){ setStat("No edits queued.", "err"); return; }
    setStat("Patching…");
    const payload = hasAnalyze ? { file: fileB64, edits, styles: stylesMap() } : { file: fileB64, edits };
    const r = await fetch(API_EDIT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!r.ok){ const t = await r.text(); throw new Error(t || r.statusText); }
    const { pdf } = await r.json();
    const blob = fromB64(pdf);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='Gravitational_Aura_Masterclass_FINAL_CLEAN_v4.pdf'; a.click();
    setStat("Done ✓ File downloaded.", "ok");
  }catch(err){ setStat("Error: " + err.message, "err"); }
};

// styles map
function stylesMap(){
  const map={};
  if(!hasAnalyze || !analysis || !analysis.pages) return map;
  for(const pg of analysis.pages){
    map[String(pg.page)] = {};
    (pg.styles||[]).forEach((s, idx)=>{
      map[String(pg.page)][String(idx)] = { font:s.font, size:s.size, color:s.color };
    });
  }
  return map;
}
</script>
</body>
</html>
