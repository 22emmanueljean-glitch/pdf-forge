<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF Forge — Stable Editor</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<style>
  :root{--bg:#0f1115;--panel:#151821;--card:#1a1f2b;--muted:#9aa3b2;--accent:#7aa2ff;--ok:#3ecf8e;--err:#ff6b6b;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e7eaf0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:16px;height:100vh}
  @media (max-width:980px){.wrap{grid-template-columns:1fr;height:auto}}
  .left{padding:16px;overflow:auto;background:#151821;border-right:1px solid #1f2330}
  .right{padding:0 0 16px 0;overflow:auto;background:#0b0d13}
  h1{font-size:18px;margin:6px 0 10px}
  .card{background:#1a1f2b;border:1px solid #22283a;border-radius:12px;padding:12px;margin:10px 0}
  label{font-size:12px;color:#9aa3b2}
  input,textarea,select,button{width:100%;margin-top:6px}
  input,textarea,select{background:#121620;border:1px solid #2a3246;color:#e7eaf0;border-radius:10px;padding:10px}
  textarea{min-height:120px;font-family:ui-monospace,Menlo,Consolas,monospace;resize:vertical}
  button{background:#7aa2ff;border:0;border-radius:10px;padding:12px;font-weight:700;color:#0b0d13;cursor:pointer}
  button.secondary{background:#28304a;color:#e7eaf0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .status{margin-top:8px;font-size:12px;color:#9aa3b2}
  .status.ok{color:#3ecf8e} .status.err{color:#ff6b6b}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#22283a;color:#c7d0e0;font-size:12px;margin-right:6px}

  .stage {display:flex;justify-content:center}
  .pageWrap {position:relative; display:inline-block; margin:12px auto; background:#0b0d13; border:1px solid #1a1f2b; border-radius:6px;}
  canvas {display:block}
  .overlay {position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:none}
  .block {position:absolute; min-width:80px; min-height:30px; padding:6px 8px;
          background:#111523d0; border:1px dashed #7aa2ff; border-radius:6px;
          color:#e7eaf0; pointer-events:auto; cursor:move; white-space:pre-wrap; line-height:1.35}
  .handle {position:absolute; right:-8px; bottom:-8px; width:14px; height:14px;
           border:2px solid #7aa2ff; border-radius:3px; background:#111523; cursor:nwse-resize}
  .toolbar{position:sticky; top:0; z-index:2; display:flex; gap:8px; align-items:center;
           padding:12px; border-bottom:1px solid #1a1f2b; background:#0b0d13}
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h1>PDF Forge — Stable</h1>

    <div class="card">
      <label>Upload PDF</label>
      <input type="file" id="file" accept="application/pdf" />
      <div class="row" style="margin-top:10px">
        <button id="load">Load Preview</button>
        <button id="reset" class="secondary">Clear</button>
      </div>
      <div class="status" id="stat">No file loaded.</div>
    </div>

    <div class="card" id="tools" style="display:none">
      <div class="row">
        <div>
          <label>Page</label>
          <select id="pageSelect"></select>
        </div>
        <div>
          <label>Zoom</label>
          <input type="range" id="zoom" min="50" max="200" value="110">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Font</label>
          <input id="font" value="Times-Roman">
        </div>
        <div>
          <label>Size (pt)</label>
          <input id="size" type="number" step="0.5" value="11">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Color</label>
          <input id="color" type="color" value="#000000">
        </div>
        <div>
          <label>Width (pt)</label>
          <input id="width" type="number" value="460">
        </div>
      </div>

      <label>Text</label>
      <textarea id="text" placeholder="Type your text to insert…"></textarea>

      <div class="row">
        <button id="add">Add Block (click preview to place)</button>
        <button id="apply" class="secondary">Generate v4</button>
      </div>

      <div class="status" id="queued">0 queued</div>
    </div>
  </div>

  <div class="right">
    <div class="toolbar">
      <span class="pill" id="meta">Page — | scale 1.00</span>
      <button id="prev" class="secondary">◀</button>
      <button id="next" class="secondary">▶</button>
    </div>
    <div class="stage">
      <div class="pageWrap" id="pageWrap" style="display:none">
        <canvas id="cv"></canvas>
        <div class="overlay" id="overlay"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// --- helpers ---
async function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => {
      const res = String(fr.result || '');
      const base64 = res.includes(',') ? res.split(',')[1] : res;
      resolve(base64);
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
function hexToRgb01(hex){
  const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if(!m) return [0,0,0];
  return [ parseInt(m[1],16)/255, parseInt(m[2],16)/255, parseInt(m[3],16)/255 ];
}

// --- state ---
const API_EDIT = "/api/edit";
let pdfDoc=null, pageNum=1, pageCount=1, scale=1.10, ptPerPx=1;
let fileB64=null, lastClickPx=null, lastClickPt=null;
let blocks=[];

const $ = id => document.getElementById(id);
const setStat = (t,cls="") => { const el=$('stat'); el.textContent=t; el.className="status "+cls; };
const setMeta = () => $('meta').textContent = `Page ${pageNum} | scale ${scale.toFixed(2)}`;
const setQueued = () => $('queued').textContent = blocks.length + " queued";

const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// --- Load ---
$('load').onclick = async () => {
  try{
    const f = $('file').files[0]; if(!f){ setStat("Choose a PDF."); return; }
    fileB64 = await fileToBase64(f);
    const buf = await f.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({data: buf}).promise;
    pageCount = pdfDoc.numPages; pageNum = 1;
    $('tools').style.display='';
    const sel=$('pageSelect'); sel.innerHTML="";
    for(let i=1;i<=pageCount;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); sel.appendChild(o); }
    sel.value="1";
    await renderPage(); drawBlocks();
    setStat(`Loaded ${pageCount} page(s).`, "ok");
  }catch(e){ setStat("Error: "+e.message, "err"); }
};

$('reset').onclick = ()=>{
  pdfDoc=null; fileB64=null; blocks=[]; $('tools').style.display='none';
  $('cv').getContext('2d').clearRect(0,0,$('cv').width,$('cv').height);
  $('overlay').innerHTML=""; $('pageWrap').style.display='none';
  setQueued(); setStat("Cleared.");
};

$('prev').onclick = async()=>{ if(!pdfDoc)return; pageNum=Math.max(1,pageNum-1); $('pageSelect').value=String(pageNum); await renderPage(); drawBlocks(); };
$('next').onclick = async()=>{ if(!pdfDoc)return; pageNum=Math.min(pageCount,pageNum+1); $('pageSelect').value=String(pageNum); await renderPage(); drawBlocks(); };
$('zoom').oninput = async e=>{ if(!pdfDoc)return; scale=Number(e.target.value)/100; await renderPage(); drawBlocks(); };
$('pageSelect').onchange = async e=>{ pageNum=Number(e.target.value)||1; await renderPage(); drawBlocks(); };

async function renderPage(){
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale });
  const cv=$('cv'), ctx=cv.getContext('2d');
  cv.width=viewport.width; cv.height=viewport.height;
  const baseViewport = page.getViewport({ scale:1 });
  ptPerPx = baseViewport.width / viewport.width;
  await page.render({ canvasContext: ctx, viewport }).promise;
  $('pageWrap').style.display='';
  setMeta();
}

// --- Click for placement ---
$('cv').addEventListener('pointerdown', e=>{
  const rect = $('cv').getBoundingClientRect();
  const pxX = e.clientX - rect.left;
  const pxY = e.clientY - rect.top;
  lastClickPx = {x:pxX, y:pxY};
  lastClickPt = {x:Math.round(pxX*ptPerPx), y:Math.round(pxY*ptPerPx)};
});

// --- Add block ---
$('add').onclick = ()=>{
  if(!fileB64){ setStat("Load a PDF first.","err"); return; }
  if(!lastClickPt){ setStat("Click preview first.","err"); return; }
  const pg = Number($('pageSelect').value)||pageNum;
  const text=$('text').value||"";
  const font=$('font').value||"Times-Roman";
  const size=parseFloat($('size').value)||11;
  const colorHex=$('color').value||"#000000";
  const widthPt=parseFloat($('width').value)||460;
  const id=Date.now()+"-"+Math.random();
  blocks.push({id,page:pg,xPt:lastClickPt.x,yPt:lastClickPt.y,widthPt,text,font,size,colorHex});
  setQueued(); drawBlocks();
  $('text').value=""; setStat("Block added.","ok");
};

// --- Draw overlay blocks ---
function drawBlocks(){
  const ov=$('overlay'); ov.innerHTML="";
  blocks.filter(b=>b.page===pageNum).forEach(b=>{
    const div=document.createElement('div');
    div.className='block';
    div.style.left=(b.xPt/ptPerPx)+'px';
    div.style.top=(b.yPt/ptPerPx)+'px';
    div.style.width=(b.widthPt/ptPerPx)+'px';
    div.style.fontFamily=b.font;
    div.style.fontSize=(b.size/ptPerPx)+'px';
    div.style.color=b.colorHex;
    div.textContent=b.text;
    const handle=document.createElement('div'); handle.className='handle'; div.appendChild(handle);

    // Move
    div.addEventListener('pointerdown',ev=>{
      if(ev.target===handle)return;
      div.setPointerCapture(ev.pointerId);
      const sx=ev.clientX, sy=ev.clientY;
      const sl=parseFloat(div.style.left), st=parseFloat(div.style.top);
      const move=e=>{
        div.style.left=(sl+(e.clientX-sx))+'px';
        div.style.top=(st+(e.clientY-sy))+'px';
      };
      const up=e=>{
        div.releasePointerCapture(ev.pointerId);
        div.removeEventListener('pointermove',move);
        div.removeEventListener('pointerup',up);
        b.xPt=Math.round(parseFloat(div.style.left)*ptPerPx);
        b.yPt=Math.round(parseFloat(div.style.top)*ptPerPx);
      };
      div.addEventListener('pointermove',move);
      div.addEventListener('pointerup',up);
    });

    // Resize
    handle.addEventListener('pointerdown',ev=>{
      ev.stopPropagation();
      div.setPointerCapture(ev.pointerId);
      const sx=ev.clientX; const sw=parseFloat(div.style.width);
      const move=e=>{
        const dx=e.clientX-sx;
        div.style.width=Math.max(60,sw+dx)+'px';
      };
      const up=e=>{
        div.releasePointerCapture(ev.pointerId);
        div.removeEventListener('pointermove',move);
        div.removeEventListener('pointerup',up);
        b.widthPt=Math.round(parseFloat(div.style.width)*ptPerPx);
      };
      div.addEventListener('pointermove',move);
      div.addEventListener('pointerup',up);
    });

    ov.appendChild(div);
  });
  ov.style.pointerEvents='none';
  Array.from(ov.children).forEach(c=>c.style.pointerEvents='auto');
}

// --- Generate v4 ---
$('apply').onclick = async ()=>{
  try{
    if(!fileB64){ setStat("Load a PDF first.","err"); return; }
    if(blocks.length===0){ setStat("No edits queued.","err"); return; }
    setStat("Generating…");
    const edits=blocks.map(b=>{
      const [r,g,bx]=hexToRgb01(b.colorHex);
      return {page:b.page,x:b.xPt,y:b.yPt,text:b.text,font:b.font,size:b.size,color:[r,g,bx],width:b.widthPt};
    });
    const r=await fetch(API_EDIT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({file:fileB64,edits})});
    if(!r.ok){const t=await r.text();throw new Error(t||r.statusText);}
    const {pdf}=await r.json();
    const blob=new Blob([Uint8Array.from(atob(pdf),c=>c.charCodeAt(0))],{type:'application/pdf'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='Gravitational_Aura_Masterclass_FINAL_CLEAN_v4.pdf'; a.click();
    setStat("Done ✓ File downloaded.","ok");
  }catch(e){ setStat("Error: "+e.message,"err"); }
};
</script>
</body>
</html>
