<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF Forge — Pro</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<style>
body{margin:0;background:#0f1115;color:#e7eaf0;font-family:Inter,system-ui,sans-serif}
.wrap{display:grid;grid-template-columns:380px 1fr;height:100vh}
.left{background:#151821;padding:16px;overflow:auto}
.right{background:#0b0d13;overflow:auto}
.card{background:#1a1f2b;border:1px solid #22283a;border-radius:10px;padding:12px;margin-bottom:12px}
input,button,textarea{width:100%;margin-top:6px;border-radius:8px;padding:8px;background:#121620;color:#e7eaf0;border:1px solid #2a3246}
button{cursor:pointer;background:#7aa2ff;color:#0b0d13;font-weight:700}
button.secondary{background:#28304a;color:#e7eaf0}
.stage{display:flex;justify-content:center}
.pageWrap{position:relative;margin:12px auto}
canvas{display:block}
.block{position:absolute;border:1px dashed #7aa2ff;padding:4px;border-radius:4px;cursor:grab;background:transparent;white-space:pre-wrap;line-height:1.35}
.block.dragging{cursor:grabbing}
.handle{position:absolute;width:12px;height:12px;border:2px solid #7aa2ff;background:#111523}
.h-tl{top:-8px;left:-8px;cursor:nwse-resize}
.h-tr{top:-8px;right:-8px;cursor:nesw-resize}
.h-bl{bottom:-8px;left:-8px;cursor:nesw-resize}
.h-br{bottom:-8px;right:-8px;cursor:nwse-resize}
.close{position:absolute;top:-8px;left:-8px;width:18px;height:18px;background:#ff6b6b;color:#0b0d13;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}
.marquee{position:absolute;border:1px solid #7aa2ff;background:rgba(122,162,255,.15);pointer-events:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h2>PDF Forge</h2>
    <div class="card">
      <label>Upload PDF</label>
      <input type="file" id="file" accept="application/pdf"/>
      <button id="load">Load</button>
    </div>
    <div class="card" id="tools" style="display:none">
      <button id="areaClone">Select Area (Clone)</button>
      <button id="export" class="secondary">Generate PDF</button>
      <div id="status" style="font-size:12px;margin-top:6px;color:#9aa3b2">Ready</div>
    </div>
  </div>
  <div class="right">
    <div class="stage">
      <div class="pageWrap">
        <canvas id="cv"></canvas>
        <div id="overlay"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
const $=id=>document.getElementById(id);
let fileB64=null,pdf=null,page=1,scale=1.1,ptPerPx=1,pageH=0,items=[];
const pdfjs=window['pdfjs-dist/build/pdf'];
pdfjs.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function toB64(f){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result.split(',')[1]);
    fr.onerror=rej;
    fr.readAsDataURL(f);
  });
}

$('load').onclick=async()=>{
  const f=$('file').files[0];
  if(!f)return;
  fileB64=await toB64(f);
  const buf=await f.arrayBuffer();
  pdf=await pdfjs.getDocument({data:buf}).promise;
  const p=await pdf.getPage(1);
  const vp=p.getViewport({scale});
  const base=p.getViewport({scale:1});
  const cv=$('cv');
  cv.width=vp.width;
  cv.height=vp.height;
  ptPerPx=base.width/vp.width;
  pageH=base.height;
  await p.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise;
  $('tools').style.display='block';
};

function pickColor(px,py){
  const cv=$('cv'),ctx=cv.getContext('2d');
  const s=17,h=(s-1)/2;
  const x0=Math.max(0,Math.round(px)-h),y0=Math.max(0,Math.round(py)-h);
  const w=Math.min(s,cv.width-x0),hh=Math.min(s,cv.height-y0);
  const data=ctx.getImageData(x0,y0,w,hh).data;
  const arr=[];
  for(let i=0;i<data.length;i+=4){
    const r=data[i],g=data[i+1],b=data[i+2];
    const max=Math.max(r,g,b),min=Math.min(r,g,b);
    const sat=max?((max-min)/max):0;
    const lum=0.2126*r+0.7152*g+0.0722*b;
    arr.push({r,g,b,sat,lum});
  }
  arr.sort((A,B)=>A.lum-B.lum||B.sat-A.sat);
  const take=Math.min(10,arr.length);
  let R=0,G=0,B=0;
  for(let i=0;i<take;i++){R+=arr[i].r;G+=arr[i].g;B+=arr[i].b;}
  R/=take;G/=take;B/=take;
  const h2=v=>Math.round(v).toString(16).padStart(2,'0');
  return '#'+h2(R)+h2(G)+h2(B);
}

$('cv').addEventListener('pointerdown',e=>{
  if(areaMode)startMarquee(e);
});

let areaMode=false,marquee=null,start=null;
$('areaClone').onclick=()=>{areaMode=!areaMode;$('status').textContent=areaMode?"Drag to select area":"";}

function startMarquee(e){
  const r=$('cv').getBoundingClientRect();
  const x=e.clientX-r.left,y=e.clientY-r.top;
  marquee=document.createElement('div');
  marquee.className='marquee';
  marquee.style.left=x+'px';
  marquee.style.top=y+'px';
  $('overlay').appendChild(marquee);
  start={x,y};

  const move=ev=>{
    const cx=ev.clientX-r.left,cy=ev.clientY-r.top;
    marquee.style.left=Math.min(x,cx)+'px';
    marquee.style.top=Math.min(y,cy)+'px';
    marquee.style.width=Math.abs(cx-x)+'px';
    marquee.style.height=Math.abs(cy-y)+'px';
  };

  const up=()=>{
    document.removeEventListener('pointermove',move);
    document.removeEventListener('pointerup',up);
    const rect=marquee.getBoundingClientRect(),cvR=r;
    const sel={x:rect.left-cvR.left,y:rect.top-cvR.top,w:rect.width,h:rect.height};
    const selPt={x:sel.x*ptPerPx,y:sel.y*ptPerPx,w:sel.w*ptPerPx,h:sel.h*ptPerPx};
    clone(selPt);
    marquee.remove();marquee=null;areaMode=false;
  };

  document.addEventListener('pointermove',move);
  document.addEventListener('pointerup',up);
}

async function clone(rect){
  const r=await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({file_b64:fileB64,page,rect})});
  const j=await r.json();
  if(!j.spans?.length){$('status').textContent='No text';return;}
  j.spans.sort((a,b)=>a.y-b.y||a.x-b.x);
  for(const s of j.spans){
    const color=pickColor((s.x+s.w/2)/ptPerPx,(s.y+s.size*0.7)/ptPerPx);
    const id=crypto.randomUUID();
    items.push({id,page,type:'text',x:s.x,y:s.y,width:s.w,text:s.text,font_mapped:s.font_mapped,size:s.size,colorHex:color,line_height:Math.round(s.size*1.35)});
  }
  draw();
}

function draw(){
  const ov=$('overlay');
  ov.innerHTML='';
  for(const it of items.filter(i=>i.page===page)){
    const d=document.createElement('div');
    d.className='block';
    d.dataset.id=it.id;
    d.style.left=(it.x/ptPerPx)+'px';
    d.style.top=(it.y/ptPerPx)+'px';
    d.style.width=(it.width/ptPerPx)+'px';
    d.style.fontFamily=it.font_mapped;
    d.style.fontSize=(it.size/ptPerPx)+'px';
    d.style.color=it.colorHex;
    d.textContent=it.text;

    const c=document.createElement('div');
    c.className='close';
    c.textContent='×';
    c.onclick=ev=>{
      ev.stopPropagation();
      items=items.filter(x=>x.id!==it.id);
      draw();
    };
    d.appendChild(c);

    ['h-tl','h-tr','h-bl','h-br'].forEach(hc=>{
      const h=document.createElement('div');
      h.className='handle '+hc;
      d.appendChild(h);
    });

    makeDrag(d,it);
    makeResize(d,it);
    ov.appendChild(d);
  }
}

function makeDrag(d,it){
  d.onpointerdown=e=>{
    if(e.target.classList.contains('handle')||e.target.classList.contains('close'))return;
    const sx=e.clientX,sy=e.clientY;
    const sl=parseFloat(d.style.left),st=parseFloat(d.style.top);
    const move=ev=>{
      const dx=ev.clientX-sx,dy=ev.clientY-sy;
      d.style.transform=`translate(${dx}px,${dy}px)`;
    };
    const up=ev=>{
      document.removeEventListener('pointermove',move);
      document.removeEventListener('pointerup',up);
      const dx=ev.clientX-sx,dy=ev.clientY-sy;
      d.style.transform='';
      it.x=Math.round((sl+dx)*ptPerPx);
      it.y=Math.round((st+dy)*ptPerPx);
      draw();
    };
    document.addEventListener('pointermove',move);
    document.addEventListener('pointerup',up);
  };
}

function makeResize(d,it){
  d.querySelectorAll('.handle').forEach(h=>{
    h.onpointerdown=e=>{
      e.stopPropagation();
      const r=d.getBoundingClientRect();
      const sx=e.clientX,sy=e.clientY;
      const sl=r.left,st=r.top,sw=r.width,sh=r.height;
      const corner=h.classList[1];
      const move=ev=>{
        const dx=ev.clientX-sx,dy=ev.clientY-sy;
        let nl=sl,nt=st,nw=sw,nh=sh;
        if(corner==='h-br'){nw=sw+dx;nh=sh+dy;}
        if(corner==='h-tr'){nw=sw+dx;nh=sh-dy;nt=st+dy;}
        if(corner==='h-bl'){nw=sw-dx;nh=sh+dy;nl=sl+dx;}
        if(corner==='h-tl'){nw=sw-dx;nh=sh-dy;nl=sl+dx;nt=st+dy;}
        d.style.left=nl+'px';
        d.style.top=nt+'px';
        d.style.width=nw+'px';
        d.style.height=nh+'px';
      };
      const up=()=>{
        document.removeEventListener('pointermove',move);
        document.removeEventListener('pointerup',up);
        const r2=d.getBoundingClientRect();
        it.width=Math.round(r2.width*ptPerPx);
        it.x=Math.round(r2.left*ptPerPx);
        it.y=Math.round(r2.top*ptPerPx);
        draw();
      };
      document.addEventListener('pointermove',move);
      document.addEventListener('pointerup',up);
    };
  });
}

$('export').onclick=async()=>{
  if(!fileB64||!items.length){$('status').textContent='Nothing to export';return;}
  const payload=items.map(i=>{
    const rgb=i.colorHex.match(/[A-Fa-f0-9]{2}/g).map(x=>parseInt(x,16)/255);
    return {type:'text',page:i.page,x:i.x,y:i.y,width:i.width,text:i.text,font_mapped:i.font_mapped,size:i.size,color:rgb,line_height:i.line_height};
  });
  $('status').textContent='Generating...';
  const r=await fetch('/api/export',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({file_b64:fileB64,blocks:payload})});
  const j=await r.json();
  const blob=new Blob([Uint8Array.from(atob(j.file_b64),c=>c.charCodeAt(0))],{type:'application/pdf'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='Edited.pdf';a.click();
  $('status').textContent='Done ✓';
};
</script>
</body>
</html>
